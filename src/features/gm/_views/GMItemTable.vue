<template>
  <div>
    <v-data-table
      v-model="selected"
      :items="items"
      :group-by="grouping === 'None' ? [] : grouping"
      :sort-by="sorting"
      :headers="headers"
      :items-per-page="-1"
      hide-default-footer
      show-select
      item-key="ID"
    >
      <template v-slot:[`body.prepend`]>
        <v-scroll-y-reverse-transition>
          <v-menu v-if="selected.length" offset-x left bottom>
            <template v-slot:activator="{ on }">
              <v-btn color="error" class="my-1 mx-2" v-on="on">
                <v-icon>mdi-delete</v-icon>
              </v-btn>
            </template>
            <v-card>
              <v-card-text>
                Do you want to delete the {{ selected.length }} selected items? This action cannot
                be undone.
              </v-card-text>
              <v-divider />
              <v-card-actions>
                <v-spacer />
                <v-btn small color="error" @click="deleteAllSelected()">
                  Confirm Deletion
                </v-btn>
              </v-card-actions>
            </v-card>
          </v-menu>
        </v-scroll-y-reverse-transition>
      </template>
      <!-- <template v-slot:[`item.Campaigns`]="{ item }">
        <v-chip
          v-for="c in item.Campaigns"
          :key="`${item.ID}_campaign_${c}`"
          small
          color="accent"
          outlined
          class="mr-1"
        >
          {{ c }}
        </v-chip>
      </template> -->
      <template v-slot:[`item.Templates`]="{ item }">
        {{ item.Templates.map(x => x.Name).join(' / ') }}
      </template>
      <template v-slot:[`item.Labels`]="{ item }">
        <v-chip v-for="l in item.Labels" :key="`${item.ID}_label_${l}`" small outlined class="mr-1">
          {{ l }}
        </v-chip>
      </template>
      <template v-slot:[`item.ItemType`]="{ item }">
        <v-btn small color="primary" class="white--text" @click="$emit('open', item.ID)">
          <v-icon left>mdi-open-in-new</v-icon>
          Open
        </v-btn>
      </template>
    </v-data-table>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import _ from 'lodash'
import * as headers from './_components/gmItemHeaders'
import { getModule } from 'vuex-module-decorators'
import { NpcStore } from '@/store'

export default Vue.extend({
  name: 'item-table',
  data: () => ({
    selected: [],
  }),
  props: {
    items: { type: Array, required: true },
    itemType: { type: String, required: true },
    grouping: { type: String, required: false, default: 'None' },
    sorting: { type: String, required: false, default: 'Name' },
    sortDir: { type: String, required: false, default: 'asc' },
  },
  computed: {
    headers() {
      return headers[this.itemType]
    },
    groupings() {
      if (this.grouping === 'None') return ['All']
      return _.uniq(this.items.flatMap(x => x[this.grouping]))
    },
  },
  methods: {
    groupedItems(group) {
      if (this.grouping === 'None') return this.items
      return this.items.filter(x => x[this.grouping].some(y => y === group))
      // return _.orderBy(
      //   this.sorting,
      //   this.sortDir
      // )
    },
    deleteAllSelected() {
      this.selected.forEach(e => {
        const store = getModule(NpcStore, this.$store)
        store[`delete${this.ItemType}`](this.selected)
      })
    },
  },
})
</script>
